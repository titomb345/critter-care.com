---
import BaseLayout from '../layouts/BaseLayout.astro';
import Hero from '../components/Hero.astro';
import TestimonialCard from '../components/TestimonialCard.astro';
import Lightbox from '../components/Lightbox.astro';
import { testimonials } from '../content/testimonials.json';

const featured = testimonials.filter(t => t.featured);
const rest = testimonials.filter(t => !t.featured);
---

<BaseLayout title="Testimonials â€” Critter Care | South Bay Pet Sitting Reviews" description="Read what our happy clients have to say about Critter Care's pet sitting services.">
  <Hero title="Testimonials" subtitle="A selection of stories from clients who've trusted us with their furry family members." />

  <!-- Featured testimonials -->
  <section class="max-w-5xl mx-auto px-4 sm:px-6 lg:px-8 pt-16 pb-12">
    <h2 class="font-heading text-lg text-heading/70 mb-2">A Few Kind Words from Our Clients</h2>
    <p class="text-sm text-muted/60 mb-8">A small sampling from families we've cared for over the years.</p>
    <div class="columns-1 sm:columns-2 gap-8 space-y-8">
      {featured.map(t => (
        <div class="break-inside-avoid">
          <TestimonialCard name={t.name} quote={t.quote} images={t.images} featured />
        </div>
      ))}
    </div>
  </section>

  <!-- Divider -->
  <div class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8 pt-2 pb-6">
    <hr class="border-border/20 mb-6" />
    <p class="font-heading text-sm uppercase tracking-wider text-heading/40">More from our clients</p>
  </div>

  <!-- Remaining testimonials -->
  <section class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8 pt-8 pb-16">
    <div class="columns-1 sm:columns-2 lg:columns-3 gap-10 space-y-12">
      {rest.map(t => (
        <div class="break-inside-avoid">
          <TestimonialCard name={t.name} quote={t.quote} images={t.images} />
        </div>
      ))}
    </div>
  </section>

  <!-- Review modal for full testimonials -->
  <div id="review-modal" class="review-modal-overlay" role="dialog" aria-modal="true" aria-label="Full review">
    <div class="review-modal-panel">
      <button class="review-modal-close" aria-label="Close">&times;</button>
      <div class="text-primary text-3xl mb-3" aria-hidden="true">&ldquo;</div>
      <blockquote id="review-modal-quote" class="text-muted leading-relaxed text-base mb-6"></blockquote>
      <div class="pt-3 border-t border-border/30 mb-6">
        <span id="review-modal-name" class="font-heading text-sm font-semibold text-heading"></span>
      </div>
      <div id="review-modal-photos" class="flex gap-2 flex-wrap"></div>
    </div>
  </div>

  <!-- Lightbox for testimonial photos (delegated for dynamic modal photos) -->
  <Lightbox selector=".testimonial-img-btn" delegated />

  <script is:inline>
    (function() {
      var reviewModal = document.getElementById('review-modal');
      var reviewQuote = document.getElementById('review-modal-quote');
      var reviewName = document.getElementById('review-modal-name');
      var reviewPhotos = document.getElementById('review-modal-photos');

      function openReview(name, quote, images, hiresImages) {
        reviewQuote.textContent = quote;
        reviewName.textContent = '\u2014 ' + name;
        reviewPhotos.innerHTML = '';

        if (images && images.length > 0) {
          images.forEach(function(img, i) {
            var btn = document.createElement('button');
            btn.className = 'testimonial-img-btn cursor-pointer rounded-lg overflow-hidden';
            btn.dataset.images = JSON.stringify(hiresImages);
            btn.dataset.index = i;
            var imgEl = document.createElement('img');
            imgEl.src = img;
            imgEl.alt = 'Pet from ' + name;
            imgEl.className = 'w-20 h-20 object-cover hover:opacity-80 transition-opacity';
            imgEl.loading = 'lazy';
            btn.appendChild(imgEl);
            reviewPhotos.appendChild(btn);
          });
        }

        reviewModal.classList.add('active');
        document.body.style.overflow = 'hidden';
      }

      function closeReview() {
        reviewModal.classList.remove('active');
        // Only restore scroll if no other overlay (e.g. lightbox) is active on top
        var otherActive = document.querySelector('.lightbox-overlay.active');
        if (!otherActive) {
          document.body.style.overflow = '';
        }
      }

      document.addEventListener('click', function(e) {
        var btn = e.target.closest('.review-read-more');
        if (btn) {
          var images = JSON.parse(btn.dataset.images || '[]');
          var hiresImages = JSON.parse(btn.dataset.hiresImages || '[]');
          openReview(btn.dataset.name, btn.dataset.quote, images, hiresImages);
        }
      });

      reviewModal.querySelector('.review-modal-close').addEventListener('click', closeReview);
      reviewModal.addEventListener('click', function(e) { if (e.target === reviewModal) closeReview(); });

      document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape' && reviewModal.classList.contains('active')) {
          closeReview();
        }
      });
    })();
  </script>

  <!-- CTA -->
  <section class="bg-surface py-12">
    <div class="max-w-3xl mx-auto px-4 sm:px-6 lg:px-8 text-center">
      <h2 class="font-heading text-2xl font-bold text-heading mb-3">Join Our Happy Clients</h2>
      <p class="text-muted mb-6">We'd love to care for your furry family members too.</p>
      <a href="/hire-us" class="btn-primary">
        Get Started
      </a>
    </div>
  </section>
</BaseLayout>
