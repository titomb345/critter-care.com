---
import { Image, getImage } from 'astro:assets';
import Lightbox from './Lightbox.astro';

const imageModules = import.meta.glob<{ default: ImageMetadata }>(
  '../assets/images/gallery/*.jpg',
  { eager: true }
);

const photos = Object.entries(imageModules)
  .sort(([a], [b]) => {
    const numA = parseInt(a.match(/photo-(\d+)/)?.[1] ?? '0');
    const numB = parseInt(b.match(/photo-(\d+)/)?.[1] ?? '0');
    return numA - numB;
  })
  .map(([, mod]) => mod.default);

const fullSizeUrls = await Promise.all(
  photos.map(async (img) => {
    const full = await getImage({ src: img, format: 'webp' });
    return full.src;
  })
);
---

{photos.length > 0 ? (
  <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-4">
    {photos.map((photo, i) => (
      <button
        class="gallery-thumb aspect-square overflow-hidden rounded-xl shadow-sm hover:shadow-lg transition-all duration-300 cursor-pointer border border-border/30 hover:border-primary-light/50 focus-visible:outline-2 focus-visible:outline-primary focus-visible:outline-offset-2 group"
        data-index={i}
        data-src={fullSizeUrls[i]}
        data-alt={`Critter Care pet photo ${i + 1}`}
      >
        <Image
          src={photo}
          alt={`Critter Care pet photo ${i + 1}`}
          width={300}
          class="w-full h-full object-cover group-hover:scale-105 transition-transform duration-300"
          loading="lazy"
        />
      </button>
    ))}
  </div>
) : (
  <p class="text-center text-muted py-12">Photos coming soon!</p>
)}

<Lightbox selector=".gallery-thumb" />
