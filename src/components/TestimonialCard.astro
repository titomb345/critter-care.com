---
interface Props {
  name: string;
  quote: string;
  images?: string[];
  featured?: boolean;
}

const { name, quote, images = [], featured = false } = Astro.props;

const TRUNCATE_LENGTH = 300;
const isLong = quote.length > TRUNCATE_LENGTH;
const excerpt = isLong
  ? quote.slice(0, TRUNCATE_LENGTH).replace(/\s+\S*$/, '') + '\u2026'
  : quote;

// Use hi-res paths if available, otherwise fall back to regular images
// Hi-res: /images/testimonials/name-1.jpg â†’ /images/testimonials/name-1-hires.jpg
import fs from 'node:fs';
const hiresImages = images.map(img => {
  const hiresPath = img.replace(/\.jpg$/, '-hires.jpg');
  const fsPath = `public${hiresPath}`;
  return fs.existsSync(fsPath) ? hiresPath : img;
});
---

<div class:list={[
  "bg-white rounded-2xl overflow-hidden shadow-sm hover:shadow-md transition-all duration-300",
  featured ? "border-l-4 border-sage/60 border-r border-t border-b border-r-warm-gray/50 border-t-warm-gray/50 border-b-warm-gray/50" : "border border-warm-gray/50"
]}>
  {images.length === 1 && (
    <button
      class="testimonial-img-btn w-full cursor-pointer"
      data-images={JSON.stringify(hiresImages)}
      data-index="0"
    >
      <img
        src={images[0]}
        alt={`Pet from ${name}`}
        class="w-full h-52 object-cover hover:opacity-90 transition-opacity"
        loading="lazy"
      />
    </button>
  )}
  {images.length > 1 && (
    <div class:list={[
      'grid gap-1',
      images.length === 2 ? 'grid-cols-2' : '',
      images.length === 3 ? 'grid-cols-3' : '',
      images.length >= 4 ? 'grid-cols-2' : '',
    ]}>
      {images.map((img, i) => (
        <button
          class="testimonial-img-btn cursor-pointer"
          data-images={JSON.stringify(hiresImages)}
          data-index={i}
        >
          <img
            src={img}
            alt={`Pet ${i + 1} from ${name}`}
            class="w-full h-32 object-cover hover:opacity-90 transition-opacity"
            loading="lazy"
          />
        </button>
      ))}
    </div>
  )}
  <div class={featured ? "p-8" : "p-6"}>
    <div class="text-gold text-3xl mb-3" aria-hidden="true">&ldquo;</div>
    <blockquote class:list={[
      "text-brown-light leading-relaxed mb-4",
      featured ? "text-base" : "text-sm"
    ]}>
      {excerpt}
    </blockquote>
    {isLong && (
      <button
        class="review-read-more text-sage hover:text-sage-dark font-medium text-sm mb-4 cursor-pointer"
        type="button"
        data-name={name}
        data-quote={quote}
        data-images={JSON.stringify(images)}
        data-hires-images={JSON.stringify(hiresImages)}
      >
        Read full review &rarr;
      </button>
    )}
    <div class="pt-3 border-t border-warm-gray/30">
      <span class="font-heading text-sm font-semibold text-brown">&mdash; {name}</span>
    </div>
  </div>
</div>
